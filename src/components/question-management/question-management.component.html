<div class="container py-8">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold">Qu·∫£n l√Ω c√¢u h·ªèi</h1>
    <div class="flex gap-2">
      <!-- MongoDB Connection Status -->
      <div
        class="connection-status"
        [class.connected]="mongoConfig.isConnected"
        [class.disconnected]="!mongoConfig.isConnected"
      >
        <span class="status-icon">{{
          mongoConfig.isConnected ? "üü¢" : "üî¥"
        }}</span>
        <span class="status-text">
          {{
            mongoConfig.isConnected
              ? "MongoDB Connected"
              : "MongoDB Disconnected"
          }}
        </span>
      </div>

      <button class="btn btn-secondary" (click)="openImportDialog()">
        Import JSON
      </button>
      <button class="btn btn-primary" (click)="openAddDialog()">
        Th√™m c√¢u h·ªèi
      </button>
    </div>
  </div>

  <div class="mb-6">
    <div class="flex gap-4 items-center flex-wrap">
      <input
        type="text"
        [(ngModel)]="searchTerm"
        (ngModelChange)="filterQuestions()"
        placeholder="T√¨m ki·∫øm c√¢u h·ªèi..."
        class="input flex-1 min-w-60"
      />
      <select
        [(ngModel)]="filterCategory"
        (ngModelChange)="filterQuestions()"
        class="select"
      >
        <option value="">T·∫•t c·∫£ danh m·ª•c</option>
        <option *ngFor="let category of categories" [value]="category">
          {{ category }}
        </option>
      </select>
    </div>
  </div>

  <div class="grid gap-4">
    <div
      *ngFor="let question of paginatedQuestions; let i = index"
      class="card"
    >
      <div class="flex justify-between items-start gap-4">
        <div class="flex-1">
          <h3 class="font-semibold mb-2">
          {{ (currentPage - 1) * pageSize + i + 1 }}. {{ question.content }}
          </h3>
          
          <!-- Question Type Indicator -->
          <div class="mb-2">
            <span class="type-badge" [class.single-choice]="isSingleChoice(question)" [class.multiple-choice]="!isSingleChoice(question)">
              {{ isSingleChoice(question) ? 'Ch·ªçn 1 ƒë√°p √°n' : 'Ch·ªçn nhi·ªÅu ƒë√°p √°n' }}
            </span>
          </div>
          
          <div class="grid gap-1 mb-3">
            <div
              *ngFor="let option of question.options; let j = index"
              class="text-sm px-3 py-1 rounded flex items-center gap-2"
              [class.bg-success]="isCorrectOption(j, question.correctAnswer)"
              [class.text-white]="isCorrectOption(j, question.correctAnswer)"
              [class.bg-gray-100]="!isCorrectOption(j, question.correctAnswer)"
            >
              {{ getChar(65 + j) }}. {{ option }}
              <span *ngIf="isCorrectOption(j, question.correctAnswer)" class="ml-auto">‚úì</span>
            </div>
          </div>
          
          <!-- Category Tags -->
          <div class="flex gap-2 text-xs mb-2">
            <span class="category-tag">
              {{ question.category || "Ch∆∞a ph√¢n lo·∫°i" }}
            </span>
            <span class="date-tag">
              {{ question.createdAt | date : "dd/MM/yyyy" }}
            </span>
          </div>
        </div>
        <div class="flex gap-2">
          <button
            class="btn btn-outline btn-sm"
            (click)="editQuestion(question)"
          >
            S·ª≠a
          </button>
          <button
            class="btn btn-danger btn-sm"
            (click)="confirmDeleteQuestion(question._id)"
          >
            X√≥a
          </button>
        </div>
      </div>
    </div>
  </div>

  <div
        class="flex justify-center items-center gap-4 mt-4"
        *ngIf="totalPages > 1"
      >
        <button
          class="btn btn-sm"
          (click)="changePage(-1)"
          [disabled]="currentPage === 1"
        >
          ‚¨ÖÔ∏è Tr∆∞·ªõc
        </button>
        <span>Trang {{ currentPage }} / {{ totalPages }}</span>
        <button
          class="btn btn-sm"
          (click)="changePage(1)"
          [disabled]="currentPage === totalPages"
        >
          Ti·∫øp ‚û°Ô∏è
        </button>
      </div>
  <div
    *ngIf="filteredQuestions.length === 0"
    class="text-center py-8 text-gray-500"
  >
    Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi n√†o
  </div>
</div>

<!-- Add/Edit Question Dialog -->
<div
  *ngIf="showQuestionDialog"
  class="dialog-overlay"
  (click)="closeQuestionDialog()"
>
  <div class="dialog-content" (click)="$event.stopPropagation()">
    <div class="dialog-header">
      <h2 class="text-xl font-bold">
        {{ isEditMode ? "S·ª≠a c√¢u h·ªèi" : "Th√™m c√¢u h·ªèi m·ªõi" }}
      </h2>
      <button class="dialog-close" (click)="closeQuestionDialog()">
        √ó
      </button>
    </div>

    <div class="dialog-body">
      <div class="form-group">
        <label class="form-label">N·ªôi dung c√¢u h·ªèi</label>
        <textarea
          [(ngModel)]="questionForm.content"
          class="textarea"
          rows="3"
          placeholder="Nh·∫≠p n·ªôi dung c√¢u h·ªèi..."
        ></textarea>
      </div>

      <div class="form-group">
        <label class="form-label">Lo·∫°i c√¢u h·ªèi</label>
        <div class="question-type-selector">
          <label class="type-option">
            <input
              type="radio"
              name="questionType"
              value="single"
              [(ngModel)]="questionForm.type"
              (change)="onQuestionTypeChange()"
            />
            <span>Ch·ªçn 1 ƒë√°p √°n</span>
          </label>
          <label class="type-option">
            <input
              type="radio"
              name="questionType"
              value="multiple"
              [(ngModel)]="questionForm.type"
              (change)="onQuestionTypeChange()"
            />
            <span>Ch·ªçn nhi·ªÅu ƒë√°p √°n</span>
          </label>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">C√°c ph∆∞∆°ng √°n tr·∫£ l·ªùi</label>
        <div class="space-y-3">
          <div
            *ngFor="let option of questionForm.options; let i = index"
            class="option-row"
          >
            <div class="option-header">
              <!-- Single Choice -->
              <input
                *ngIf="questionForm.type === 'single'"
                type="radio"
                [name]="'correct-answer'"
                [value]="i"
                [(ngModel)]="questionForm.correctAnswer"
                class="radio-input"
              />
              <!-- Multiple Choice -->
              <input
                *ngIf="questionForm.type === 'multiple'"
                type="checkbox"
                [checked]="isCorrectAnswerSelected(i)"
                (change)="onCorrectAnswerChange(i, $event)"
                class="checkbox-input"
              />
              <label class="option-label"
                >Ph∆∞∆°ng √°n {{ getChar(65 + i) }}</label
              >
              <!-- N√∫t x√≥a option -->
              <button
                *ngIf="questionForm.options.length > 2"
                type="button"
                class="btn-remove-option"
                (click)="removeOption(i)"
                title="X√≥a ph∆∞∆°ng √°n n√†y"
              >
                √ó
              </button>
            </div>
            <input
              type="text"
              [(ngModel)]="questionForm.options[i]"
              [placeholder]="'Nh·∫≠p n·ªôi dung ph∆∞∆°ng √°n ' + getChar(65 + i)"
              class="input"
            />
          </div>
        </div>
        
        <!-- N√∫t th√™m option -->
        <div class="mt-3" *ngIf="questionForm.options.length < 6">
          <button
            type="button"
            class="btn btn-outline btn-sm"
            (click)="addOption()"
          >
            + Th√™m ph∆∞∆°ng √°n
          </button>
        </div>
        
        <p class="form-help">
          {{ questionForm.type === 'single' ? 'Ch·ªçn radio button ƒë·ªÉ ƒë√°nh d·∫•u ƒë√°p √°n ƒë√∫ng' : 'Ch·ªçn checkbox ƒë·ªÉ ƒë√°nh d·∫•u c√°c ƒë√°p √°n ƒë√∫ng' }}
        </p>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Danh m·ª•c</label>
          <input
            type="text"
            [(ngModel)]="questionForm.category"
            class="input"
            placeholder="Nh·∫≠p danh m·ª•c..."
            list="categories-list"
          />
          <datalist id="categories-list">
            <option
              *ngFor="let category of categories"
              [value]="category"
            ></option>
          </datalist>
        </div>
      </div>
    </div>

    <div class="dialog-footer">
      <button class="btn btn-outline" (click)="closeQuestionDialog()">
        H·ªßy
      </button>
      <button 
        class="btn btn-primary" 
        (click)="confirmSaveQuestion()"
        [disabled]="isSaving"
      >
        <span *ngIf="isSaving" class="loading-spinner"></span>
        {{ isEditMode ? "C·∫≠p nh·∫≠t" : "Th√™m c√¢u h·ªèi" }}
      </button>
    </div>
  </div>
</div>

<!-- Import JSON Dialog -->
<div
  *ngIf="showImportDialog"
  class="dialog-overlay"
  (click)="closeImportDialog()"
>
  <div class="dialog-content dialog-lg" (click)="$event.stopPropagation()">
    <div class="dialog-header">
      <h2 class="text-xl font-bold">Import c√¢u h·ªèi t·ª´ JSON</h2>
      <button class="dialog-close" (click)="closeImportDialog()">√ó</button>
    </div>

    <div class="dialog-body">
      <div class="form-group">
        <label class="form-label">Ch·ªçn file JSON</label>
        <div
          class="file-upload-area"
          [class.drag-over]="isDragOver"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onDrop($event)"
          (click)="fileInput.click()"
        >
          <div class="file-upload-content">
            <div class="file-upload-icon">üìÑ</div>
            <div class="file-upload-text">
              <div *ngIf="!selectedFile" class="file-upload-primary">
                K√©o th·∫£ file JSON v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn
              </div>
              <div *ngIf="selectedFile" class="file-upload-primary">
                {{ selectedFile.name }}
              </div>
              <div class="file-upload-secondary">
                H·ªó tr·ª£ ƒë·ªãnh d·∫°ng JSON chu·∫©n ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω t·ª´ file Python
              </div>
            </div>
          </div>
          <input
            #fileInput
            type="file"
            accept=".json"
            (change)="onFileSelected($event)"
            class="file-input-hidden"
          />
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Danh m·ª•c (Category)</label>
        <select class="select" [(ngModel)]="selectedImportCategory">
          <option value="">-- Ch·ªçn danh m·ª•c --</option>
          <option value="Tin A">Tin A</option>
          <option value="Tin B">Tin B</option>
        </select>
      </div>
      <!-- Import Progress -->
      <div *ngIf="isProcessing" class="processing-status">
        <div class="processing-spinner"></div>
        <div class="processing-text">{{ processingMessage }}</div>
        <div class="progress-bar">
          <div
            class="progress-fill"
            [style.width.%]="processingProgress"
          ></div>
        </div>
      </div>

      <!-- Import Results -->
      <div *ngIf="importResults" class="import-results">
        <h3 class="results-title">K·∫øt qu·∫£ import</h3>
        <div class="results-summary">
          <div class="result-item success">
            ‚úÖ {{ importResults.questionsImported }} c√¢u h·ªèi ƒë∆∞·ª£c th√™m
          </div>
          <div
            *ngIf="importResults.duplicatesFound > 0"
            class="result-item warning"
          >
            ‚ö†Ô∏è {{ importResults.duplicatesFound }} c√¢u h·ªèi tr√πng l·∫∑p
          </div>
          <div
            *ngIf="importResults.errors.length > 0"
            class="result-item error"
          >
            ‚ùå {{ importResults.errors.length }} l·ªói x·∫£y ra
          </div>
        </div>

        <div *ngIf="importResults.errors.length > 0" class="error-details">
          <h4 class="error-title">Chi ti·∫øt l·ªói:</h4>
          <ul class="error-list">
            <li *ngFor="let error of importResults.errors">{{ error }}</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="dialog-footer">
      <button class="btn btn-outline" (click)="closeImportDialog()">
        {{ importResults ? "ƒê√≥ng" : "H·ªßy" }}
      </button>
      <button
        *ngIf="!importResults"
        class="btn btn-primary"
        (click)="confirmProcessJSON()"
        [disabled]="
          !selectedFile || !selectedImportCategory || isProcessing
        "
      >
        <span *ngIf="!isProcessing">Import</span>
        <span *ngIf="isProcessing">ƒêang x·ª≠ l√Ω...</span>
      </button>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div *ngIf="showToast" class="toast-notification" [class.toast-success]="toastType === 'success'" [class.toast-error]="toastType === 'error'">
  <div class="toast-content">
    <span class="toast-icon">{{ toastType === 'success' ? '‚úÖ' : '‚ùå' }}</span>
    <span class="toast-message">{{ toastMessage }}</span>
  </div>
  <button class="toast-close" (click)="hideToast()">√ó</button>
</div>