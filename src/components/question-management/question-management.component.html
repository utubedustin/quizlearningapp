<div class="container py-8">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold">Quáº£n lÃ½ cÃ¢u há»i</h1>
    <div class="flex gap-2">
      <!-- MongoDB Connection Status -->
      <div
        class="connection-status"
        [class.connected]="mongoConfig.isConnected"
        [class.disconnected]="!mongoConfig.isConnected"
      >
        <span class="status-icon">{{
          mongoConfig.isConnected ? "ğŸŸ¢" : "ğŸ”´"
        }}</span>
        <span class="status-text">
          {{
            mongoConfig.isConnected
              ? "MongoDB Connected"
              : "MongoDB Disconnected"
          }}
        </span>
      </div>

      <button class="btn btn-secondary" (click)="openImportDialog()">
        ğŸ“„ Import JSON
      </button>
      <button class="btn btn-primary" (click)="openAddDialog()">
        â• ThÃªm cÃ¢u há»i
      </button>
    </div>
  </div>

  <!-- Search and Filter Section -->
  <div class="search-filter-section">
    <div class="search-filter-grid">
      <input
        type="text"
        [(ngModel)]="searchTerm"
        (ngModelChange)="filterQuestions()"
        placeholder="ğŸ” TÃ¬m kiáº¿m cÃ¢u há»i..."
        class="input"
      />
      <select
        [(ngModel)]="filterCategory"
        (ngModelChange)="filterQuestions()"
        class="select"
      >
        <option value="">ğŸ“‚ Táº¥t cáº£ danh má»¥c</option>
        <option *ngFor="let category of categories" [value]="category">
          {{ category }}
        </option>
      </select>
      
      <!-- Page Size Selector -->
      <div class="flex items-center gap-2">
        <label class="text-sm text-gray-600">Hiá»ƒn thá»‹:</label>
        <select [(ngModel)]="pageSize" (ngModelChange)="onPageSizeChange()" class="select-sm">
          <option *ngFor="let size of pageSizeOptions" [value]="size">{{ size }}</option>
        </select>
        <span class="text-sm text-gray-600">cÃ¢u/trang</span>
      </div>
    </div>
  </div>

  <!-- Questions List -->
  <div class="grid gap-6">
    <div
      *ngFor="let question of paginatedQuestions; let i = index"
      class="card"
    >
      <div class="flex justify-between items-start gap-4">
        <div class="flex-1">
          <h3 class="question-content-text">
            {{ (currentPage - 1) * pageSize + i + 1 }}. {{ question.content }}
          </h3>
          
          <!-- Question Type Indicator -->
          <div class="mb-3">
            <span class="type-badge" [class.single-choice]="isSingleChoice(question)" [class.multiple-choice]="!isSingleChoice(question)">
              {{ isSingleChoice(question) ? 'ğŸ”˜ Chá»n 1 Ä‘Ã¡p Ã¡n' : 'â˜‘ï¸ Chá»n nhiá»u Ä‘Ã¡p Ã¡n' }}
            </span>
          </div>
          
          <!-- Options Display -->
          <div class="options-grid mb-4">
            <div
              *ngFor="let option of question.options; let j = index"
              class="option-display"
              [class.correct]="isCorrectOption(j, question.correctAnswer)"
              [class.incorrect]="!isCorrectOption(j, question.correctAnswer)"
            >
              <span class="option-letter">{{ getChar(65 + j) }}</span>
              <span class="option-text">{{ option }}</span>
              <span *ngIf="isCorrectOption(j, question.correctAnswer)" class="option-check">âœ“</span>
            </div>
          </div>
          
          <!-- Question Meta -->
          <div class="question-meta">
            <span class="category-tag">
              ğŸ“ {{ question.category || "ChÆ°a phÃ¢n loáº¡i" }}
            </span>
            <span class="date-tag">
              ğŸ“… {{ question.createdAt | date : "dd/MM/yyyy" }}
            </span>
          </div>
        </div>
        
        <!-- Question Actions -->
        <div class="question-actions">
          <button
            class="btn btn-outline btn-sm"
            (click)="editQuestion(question)"
          >
            âœï¸ Sá»­a
          </button>
          <button
            class="btn btn-danger btn-sm"
            (click)="confirmDeleteQuestion(question._id)"
          >
            ğŸ—‘ï¸ XÃ³a
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  <div class="pagination-controls" *ngIf="totalPages > 1">
    <button
      class="btn btn-outline btn-sm"
      (click)="changePage(-1)"
      [disabled]="currentPage === 1"
    >
      â¬…ï¸ TrÆ°á»›c
    </button>
    <div class="pagination-info">
      Trang {{ currentPage }} / {{ totalPages }} ({{ filteredQuestions.length }} cÃ¢u há»i)
    </div>
    <button
      class="btn btn-outline btn-sm"
      (click)="changePage(1)"
      [disabled]="currentPage === totalPages"
    >
      Tiáº¿p â¡ï¸
    </button>
  </div>

  <!-- Empty State -->
  <div
    *ngIf="filteredQuestions.length === 0"
    class="text-center py-12 text-gray-500"
  >
    <div class="text-6xl mb-4">ğŸ“</div>
    <h3 class="text-xl font-semibold mb-2">KhÃ´ng tÃ¬m tháº¥y cÃ¢u há»i nÃ o</h3>
    <p class="mb-4">HÃ£y thá»­ thay Ä‘á»•i tá»« khÃ³a tÃ¬m kiáº¿m hoáº·c bá»™ lá»c</p>
  </div>
</div>

<!-- Add/Edit Question Dialog -->
<div
  *ngIf="showQuestionDialog"
  class="dialog-overlay"
  (click)="closeQuestionDialog()"
>
  <div class="dialog-content" (click)="$event.stopPropagation()">
    <div class="dialog-header">
      <h2 class="text-xl font-bold">
        {{ isEditMode ? "âœï¸ Sá»­a cÃ¢u há»i" : "â• ThÃªm cÃ¢u há»i má»›i" }}
      </h2>
      <button class="dialog-close" (click)="closeQuestionDialog()">
        Ã—
      </button>
    </div>

    <div class="dialog-body">
      <div class="form-group">
        <label class="form-label">ğŸ“ Ná»™i dung cÃ¢u há»i</label>
        <textarea
          [(ngModel)]="questionForm.content"
          class="textarea"
          rows="3"
          placeholder="Nháº­p ná»™i dung cÃ¢u há»i..."
        ></textarea>
      </div>

      <div class="form-group">
        <label class="form-label">ğŸ¯ Loáº¡i cÃ¢u há»i</label>
        <div class="question-type-selector">
          <label class="type-option">
            <input
              type="radio"
              name="questionType"
              value="single"
              [(ngModel)]="questionForm.type"
              (change)="onQuestionTypeChange()"
            />
            <span>ğŸ”˜ Chá»n 1 Ä‘Ã¡p Ã¡n</span>
          </label>
          <label class="type-option">
            <input
              type="radio"
              name="questionType"
              value="multiple"
              [(ngModel)]="questionForm.type"
              (change)="onQuestionTypeChange()"
            />
            <span>â˜‘ï¸ Chá»n nhiá»u Ä‘Ã¡p Ã¡n</span>
          </label>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">ğŸ“‹ CÃ¡c phÆ°Æ¡ng Ã¡n tráº£ lá»i</label>
        <div class="space-y-3">
          <div
            *ngFor="let option of questionForm.options; let i = index"
            class="option-row"
          >
            <div class="option-header">
              <!-- Single Choice -->
              <input
                *ngIf="questionForm.type === 'single'"
                type="radio"
                [name]="'correct-answer'"
                [value]="i"
                [(ngModel)]="questionForm.correctAnswer"
                class="radio-input"
              />
              <!-- Multiple Choice -->
              <input
                *ngIf="questionForm.type === 'multiple'"
                type="checkbox"
                [checked]="isCorrectAnswerSelected(i)"
                (change)="onCorrectAnswerChange(i, $event)"
                class="checkbox-input"
              />
              <label class="option-label"
                >PhÆ°Æ¡ng Ã¡n {{ getChar(65 + i) }}</label
              >
              <!-- Remove option button -->
              <button
                *ngIf="questionForm.options.length > 2"
                type="button"
                class="btn-remove-option"
                (click)="removeOption(i)"
                title="XÃ³a phÆ°Æ¡ng Ã¡n nÃ y"
              >
                Ã—
              </button>
            </div>
            <input
              type="text"
              [(ngModel)]="questionForm.options[i]"
              [placeholder]="'Nháº­p ná»™i dung phÆ°Æ¡ng Ã¡n ' + getChar(65 + i)"
              class="input"
            />
          </div>
        </div>
        
        <!-- Add option button -->
        <div class="mt-3" *ngIf="questionForm.options.length < 6">
          <button
            type="button"
            class="btn btn-outline btn-sm"
            (click)="addOption()"
          >
            â• ThÃªm phÆ°Æ¡ng Ã¡n
          </button>
        </div>
        
        <p class="form-help">
          {{ questionForm.type === 'single' ? 'ğŸ”˜ Chá»n radio button Ä‘á»ƒ Ä‘Ã¡nh dáº¥u Ä‘Ã¡p Ã¡n Ä‘Ãºng' : 'â˜‘ï¸ Chá»n checkbox Ä‘á»ƒ Ä‘Ã¡nh dáº¥u cÃ¡c Ä‘Ã¡p Ã¡n Ä‘Ãºng' }}
        </p>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ğŸ“ Danh má»¥c</label>
          <input
            type="text"
            [(ngModel)]="questionForm.category"
            class="input"
            placeholder="Nháº­p danh má»¥c..."
            list="categories-list"
          />
          <datalist id="categories-list">
            <option
              *ngFor="let category of categories"
              [value]="category"
            ></option>
          </datalist>
        </div>
      </div>
    </div>

    <div class="dialog-footer">
      <button class="btn btn-outline" (click)="closeQuestionDialog()">
        âŒ Há»§y
      </button>
      <button 
        class="btn btn-primary" 
        (click)="confirmSaveQuestion()"
        [disabled]="isSaving"
      >
        <span *ngIf="isSaving" class="loading-spinner"></span>
        {{ isEditMode ? "ğŸ’¾ Cáº­p nháº­t" : "â• ThÃªm cÃ¢u há»i" }}
      </button>
    </div>
  </div>
</div>

<!-- Import JSON Dialog -->
<div
  *ngIf="showImportDialog"
  class="dialog-overlay"
  (click)="closeImportDialog()"
>
  <div class="dialog-content dialog-lg" (click)="$event.stopPropagation()">
    <div class="dialog-header">
      <h2 class="text-xl font-bold">ğŸ“„ Import cÃ¢u há»i tá»« JSON</h2>
      <button class="dialog-close" (click)="closeImportDialog()">Ã—</button>
    </div>

    <div class="dialog-body">
      <div class="form-group">
        <label class="form-label">ğŸ“ Chá»n file JSON</label>
        <div
          class="file-upload-area"
          [class.drag-over]="isDragOver"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onDrop($event)"
          (click)="fileInput.click()"
        >
          <div class="file-upload-content">
            <div class="file-upload-icon">ğŸ“„</div>
            <div class="file-upload-text">
              <div *ngIf="!selectedFile" class="file-upload-primary">
                KÃ©o tháº£ file JSON vÃ o Ä‘Ã¢y hoáº·c click Ä‘á»ƒ chá»n
              </div>
              <div *ngIf="selectedFile" class="file-upload-primary">
                ğŸ“ {{ selectedFile.name }}
              </div>
              <div class="file-upload-secondary">
                Há»— trá»£ Ä‘á»‹nh dáº¡ng JSON chuáº©n Ä‘Ã£ Ä‘Æ°á»£c xá»­ lÃ½ tá»« file Python
              </div>
            </div>
          </div>
          <input
            #fileInput
            type="file"
            accept=".json"
            (change)="onFileSelected($event)"
            class="file-input-hidden"
          />
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">ğŸ“‚ Danh má»¥c (Category)</label>
        <select class="select" [(ngModel)]="selectedImportCategory">
          <option value="">-- Chá»n danh má»¥c --</option>
          <option value="Tin A">ğŸ“Š Tin A</option>
          <option value="Tin B">ğŸ’» Tin B</option>
        </select>
      </div>
      <!-- Import Progress -->
      <div *ngIf="isProcessing" class="processing-status">
        <div class="processing-spinner"></div>
        <div class="processing-text">{{ processingMessage }}</div>
        <div class="progress-bar">
          <div
            class="progress-fill"
            [style.width.%]="processingProgress"
          ></div>
        </div>
      </div>

      <!-- Import Results -->
      <div *ngIf="importResults" class="import-results">
        <h3 class="results-title">ğŸ“Š Káº¿t quáº£ import</h3>
        <div class="results-summary">
          <div class="result-item success">
            âœ… {{ importResults.questionsImported }} cÃ¢u há»i Ä‘Æ°á»£c thÃªm
          </div>
          <div
            *ngIf="importResults.duplicatesFound > 0"
            class="result-item warning"
          >
            âš ï¸ {{ importResults.duplicatesFound }} cÃ¢u há»i trÃ¹ng láº·p
          </div>
          <div
            *ngIf="importResults.errors.length > 0"
            class="result-item error"
          >
            âŒ {{ importResults.errors.length }} lá»—i xáº£y ra
          </div>
        </div>

        <div *ngIf="importResults.errors.length > 0" class="error-details">
          <h4 class="error-title">ğŸ“‹ Chi tiáº¿t lá»—i:</h4>
          <ul class="error-list">
            <li *ngFor="let error of importResults.errors">{{ error }}</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="dialog-footer">
      <button class="btn btn-outline" (click)="closeImportDialog()">
        {{ importResults ? "âœ… ÄÃ³ng" : "âŒ Há»§y" }}
      </button>
      <button
        *ngIf="!importResults"
        class="btn btn-primary"
        (click)="confirmProcessJSON()"
        [disabled]="
          !selectedFile || !selectedImportCategory || isProcessing
        "
      >
        <span *ngIf="!isProcessing">ğŸ“¥ Import</span>
        <span *ngIf="isProcessing">â³ Äang xá»­ lÃ½...</span>
      </button>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div *ngIf="showToast" class="toast-notification" [class.toast-success]="toastType === 'success'" [class.toast-error]="toastType === 'error'">
  <div class="toast-content">
    <span class="toast-icon">{{ toastType === 'success' ? 'âœ…' : 'âŒ' }}</span>
    <span class="toast-message">{{ toastMessage }}</span>
  </div>
  <button class="toast-close" (click)="hideToast()">Ã—</button>
</div>